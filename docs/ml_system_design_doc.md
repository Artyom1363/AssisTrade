# ML System Design Doc
## Дизайн ML системы - AI агент для выполнение транзакций через NLP интерфейс

### **1. Цели и предпосылки**
### **1.1. Обоснованность разработки продукта**

### **Бизнес цель**
Создать помощника для выполнения транзакций через NLP интерфейс.
Сейчас, чтобы вложить актив в криптовалюту требуется глубокое погружение в область. Хочется упростить это процесс, как когда-то сделали Тинькофф инвестиции.
Требуется сделать помощника, который проведет по этапам до достижения результата (выполнения транзакции), на каждом из которых объяснит что происходит и сможет ответить на вопросы. При этом общее время должно быть снижено, по сравнению с временем, затраченным на ту же цель без использования бота.


### **Описание текущего бизнес-процесса**
<span style="color:red">На самом деле пока точно не углублялись в то, как это происходит в среднем. Тут скорее гипотеза.</span>

Текущий пользовательский путь:
- Пользователь изучает обзоры на YouTube, пытаясь повторить показанные действия;
- Сталкивается с общими объяснениями без конкретных деталей для его случая;
- Не имея возможности задать уточняющие вопросы обращается к поисковым системам, тратя значительное время на поиск релевантной информации;
- Сталкивается с техническими трудностями и непонятной терминологией;
- Вынужден самостоятельно интегрировать разрозненную информацию;
- Часто совершает ошибки из-за недостатка опыта и понимания процесса.


### **Целевая аудитория**

- Люди, желающие вложить средства в криптовалюту, без желания глубоко углубляться в технический процесс
- Люди, желающие ускорить процесс подготовки транзакций


### **Критерий успеха**
На 30% сокращено время пользователя от момента, когда он захотел вложить деньги до покупки, в сравнении с тем, чтобы человек сам разбирался с тем, как решить его задачу.


### **1.2. Бизнес-требования и ограничения**

**Целевое видение:**

- Работа в формате телеграм бота с мини апой, с подтверждением транзакции в приложении метамаска. [Видео](https://drive.google.com/file/d/13oFI2d_xw7LLEB71_ymbwK96m0Q3mtQL/view?usp=sharing)
- Пошаговые инструкции с визуальным сопровождением (скриншоты).
- Точные ответы на вопросы пользователя, в случае, если необходимо что либо объяснить.
- Пользователь успешно достигает целевого результата как минимум на 30% быстрее, чем используя другие инструменты.
- <span style="color:yellow">*Пользователь с помощью сообщений боту может осуществить транзакцию</span>
- Мультиплатформенность

**Целевое видение для MVP**
- Работа в формате телеграм бота аналогично целевому видению
- Возможность добавить контакта за одно сообщение (вся необходимая информация содержится в 1 сообщении)
- Возможность совершить транзакцию при достаточной информации в одном сообщении
- Ответы на часто задаваемые вопросы о криптовалютах и процессе покупки
- Достижение целевого результата без необходимости обращения к сторонним информационным ресурсам (поиска, LLM)


**Технические ограничения**
- Безопасность осуществления транзакций требует особого внимания - необходим механизм, не требующий передачи приватных ключей
- Требования к производительности и скорости ответа системы (не более 5 секунд задержки)


### **1.3. Что входит в скоуп проекта/итерации, что не входит**

Первая итерация - дедлайн 19 апреля 2025

- Изучение возможностей безопасной интеграции с криптокошельками
- Прототип интерфейса взаимодействия с пользователем
- Выбор и настройка фреймворка для создания LLM-агента
- Разработка базового диалогового графа для основных сценариев
- Разработка сервиса с RAG
- Разработка сервиса для добавления контактов
- Допускается отсутствие интеграции между компонентами

Вторая итерация - дедлайн 26 апреля 2025
- Интеграция с metamask
- Создание микросервиса для каждой из компонент
- Интеграция всех микросервисов между собой
- Деплой на сервере


### **1.4. Предпосылки решения**

Для MVP:
Использование готового фреймворка для создания Агентов с помощью LLM (как вариант LangChain). Возможность готовить транзакцию, если вся необходимая информация есть в одном сообщении. Возможность отвечать на вопросы с помощью RAG по документации metamask.

На будущее:
Проектируется граф диалога, по которому будет ходить агент. Граф состоит из узлов, которые должны проводить пользователя поэтапно до осуществления транзакции. Для каждого узла пишется подробное сообщение со скриншотом для очередного действия пользователя. При этом поддерживается возможность на каждом шаге задать вопрос как по процессу осуществления транзакции, так и по стороннему вопросу. Для первой стадии все работает через api LLM.


### **2. Методология `Разработчик`**

### **2.1. Постановка задачи**

**Исследовательская фаза:**

- Изучение возможностей интеграции с MetaMask и другими популярными криптокошельками
- Анализ безопасных методов осуществления транзакций без передачи приватных ключей
- Исследование и сравнительный анализ фреймворков для создания LLM-агентов

**Разработка**
- Генерация синтетических данных общения пользователя и системы.
- Разработка компоненты RAG
- Разработка интерфейса взаимодействия с пользователем (Бот в Телеграм)<span style="color:red">По этой причине поставил методологию Разработчик, а не DS</span>
- Разработка агента с минимально необходимым набором функций
- Разработка диалогового графа.
- Создание описаний для каждого узла графа, добавление скриншотов.
- Разработка агента, задача которого ходить по узлам графа.


### **2.2. Блок-схема решения**

![blocksheme](imgs/blocksheme.png)


### **3.1. Разработка RAG**
**Этапы решения**
- Домены на которых будет работать RAG
    - ✅ Документация metamask 
    - ❌ Общие вопросы по криптовалюте
    - ❌ <span style="color:yellow"> Предоставление контекстуальной информации о текущем состоянии рынка </span> -- необходимость требует обсуждения. upd: попросили сделать возможность по находить адреса определенных протоколов и уметь на них переводить. Например: положи 10 ETH в aave.
    - ❌ <span style="color:yellow"> По истории переводов </span> -- необходимость требует обсуждения
- Сбор данных
    - ✅ На первом этапе предполагается использовать синтетические вопросы, сгенерированные llm, которые потенциально может задать пользователь
    - ✅ На первом этапе для общих вопросов тоже можно спарсить какой-то сайт с русской/английской документацией
    - ✅ Для домена metamask спарсить документацию (вместе с картинками)
- Формат взаимодействия с другими системами:
    - API
        - вход: запрос
        - выход: ответ + картинки (в тексте в содержатся метки для вставки картинок)
- Оценка качества RAG:
    - ❌ Качество поиска: recall@3
    - ❌ Качество ответов: llm as a judge на релевантность. <span style="color:yellow">Тут сразу стоит определиться с тем, что должна отвечать модель, если релевантной информации от поиска не пришло. Скорее всего говорить "извините, я не могу ответить на этот вопрос"</span>

Все метрики предлагается считать на корзинках запросов

- Технологии:
    - В качестве векторной БД предлагается использовать Chroma
    - Исходные файлы документации в первое время предлагается хранить просто в виде файлов (картинки + json с текстом и html), подготовленные файлы для Chroma хранить в обычном json
    - В качестве retrieval модели предлагается на первой стадии использовать rubert-tiny2 из-за ограничения в вычислительных ресурсах. Можно также рассмотреть использование bm25, но для этого нужно иметь документацию на том же языке, что будут запросы, на текущий момент документация на английском (на русском она есть, но не получилось ее нормально спарсить).
    - В качесте generation модели предлагается использовать gigachat-api/mistral, т.к. там есть бесплатные токены
    - Предлагается из langchain использовать сплиттер и модель gigachat
    - Для реализации api предлагается использовать fastapi

- Вычислительные ресурсы
    -  Нужно как минимум 4 ядра оперативы, чтобы нормально запускался докер образ с компонентой
    -  Желательно иметь хотя бы 2 ядра cpu


**Архитектура сервиса RAG:**

![architecture](imgs/architecture.png)